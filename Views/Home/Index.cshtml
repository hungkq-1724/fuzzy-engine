@model IEnumerable<WebApplication2.Models.Article>
@using System.Web

@{
    ViewBag.Title = "Home";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Bảng tin</h2>

@if (User.Identity.IsAuthenticated)
{
    <div class="card mb-3">
        <div class="card-body">
            @using (Html.BeginForm("CreateArticle", "Home", FormMethod.Post, new { id = "articleForm" }))
            {
                @Html.AntiForgeryToken()
                <input id="articleTitle"
                       name="title"
                       class="form-control mb-2"
                       maxlength="200"
                       placeholder="Tiêu đề" />

                <textarea id="articleContent" name="content" class="form-control" rows="3" maxlength="2000" placeholder="Bạn đang nghĩ gì?"></textarea>
                <div class="mt-2 d-flex justify-content-between">
                    <small class="text-muted"><span id="charCount">0</span>/2000</small>
                    <button type="submit" class="btn btn-primary">Đăng</button>
                </div>
                <div id="postError" class="text-danger mt-2"></div>
            }
        </div>
    </div>
}
else
{
    <div class="alert alert-info">Hãy <a href="@Url.Action("Login","Session")">đăng nhập</a> để đăng bài.</div>
}

<div id="articlesList" data-delete-url="@Url.Action("DeleteArticle","Home")" data-like-url="@Url.Action("ToggleFavorite","Home")">
    @foreach (var a in Model)
    {
        <div class="card my-2" data-id="@a.Id">
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    @if (!string.IsNullOrEmpty(a.Author?.Avatar))
                    {
                        <img src="@a.Author.Avatar" class="rounded-circle me-2" style="width:32px;height:32px;" />
                    }
                    <strong>@(string.IsNullOrEmpty(a.Author?.Username) ? a.Author?.Email : a.Author?.Username)</strong>
                    <small class="text-muted ms-2">@a.CreatedAt.ToLocalTime()</small>

                    @* Chỉ hiện nút Xóa nếu là tác giả *@
                    @if (User.Identity.IsAuthenticated && a.Author?.Email == User.Identity.Name)
                    {
                        <button type="button"
                                class="btn btn-link btn-sm text-danger ms-auto btn-delete-article"
                                data-id="@a.Id">
                            Xóa
                        </button>
                    }
                </div>

                <h5 class="mb-2">@Html.Raw(HttpUtility.HtmlEncode(a.Title))</h5>
                <div>@Html.Raw(HttpUtility.HtmlEncode(a.Content).Replace("\n", "<br/>"))</div>
            </div>
            <div class="card-footer">
                <div class="ms-auto">
                    <button type="button"
                            class="btn btn-sm btn-outline-secondary btn-like"
                            data-id="@a.Id">
                        ❤ <span class="like-count">@((a.Favorites != null) ? a.Favorites.Count : 0)</span>
                    </button>

                    <button type="button"
                            class="btn btn-sm btn-outline-secondary"
                            onclick="location.href='@Url.Action("Show","Article", new { id = a.Id })'">
                        <i class="bi bi-chat-left"></i> @((a.Comments != null) ? a.Comments.Count : 0)
                    </button>
                </div>
            </div>
        </div>
    }
</div>


@section scripts{
    @Scripts.Render("~/bundles/home")
}
